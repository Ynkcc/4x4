# 暗棋强化学习 Elo 自我对弈训练框架 (RLlib版)

这是一个使用 Ray RLlib 框架实现的4x4自定义暗棋游戏自我对弈训练系统。

## 主要特性

- 使用 RLlib 的多智能体环境支持
- Elo 评分系统
- 动态对手池管理
- 自我对弈训练
- 支持人机对战
- 模型评估工具

## 快速开始

1. 安装依赖：
   ```bash
   pip install "ray[rllib]" torch gymnasium
   ```

2. 运行训练：
   ```bash
   python main.py
   ```

3. 人机对战：
   ```bash
   python scripts/human_vs_ai.py
   ```

4. 模型评估：
   ```bash
   python scripts/evaluate.py
   ```

## 项目结构

```
./
├── main.py                     # 🚀 新的主入口，启动训练
├── README.md                   # 📖 项目说明文档
├── core/                       # 核心模块
│   ├── __init__.py
│   ├── environment.py          # 原始游戏环境
│   ├── multi_agent_env.py      # RLlib多智能体环境的封装
│   ├── policy.py               # RLlib自定义策略网络
│   └── trainer.py              # 核心训练器类 RLLibSelfPlayTrainer
├── callbacks/                  # 回调模块
│   ├── __init__.py
│   └── self_play_callback.py   # 自我对弈核心逻辑的回调实现
├── utils/                      # 工具模块
│   ├── __init__.py
│   ├── constants.py            # 全局常量与超参数
│   └── elo.py                  # Elo评分管理的工具函数
└── scripts/                    # 其他可执行脚本
    ├── __init__.py
    ├── evaluate.py             # 评估两个模型表现的脚本
    └── human_vs_ai.py          # 人机对战脚本
```

## 配置说明

主要配置参数位于 `utils/constants.py` 中，包括：

- PPO算法超参数
- 自我对弈参数
- Elo评分系统配置
- 网络架构参数

## 训练流程

1. 初始化Ray和环境
2. 配置PPO算法
3. 开始自我对弈主循环
4. 每轮训练后进行评估和Elo更新
5. 满足条件时将主策略加入对手池

## 模型保存

- 检查点保存在 `tensorboard_logs/self_play_final/`
- 对手池模型保存在 `models/self_play_final/opponent_pool/`
- Elo评分保存在 `models/self_play_final/elo_ratings.json`



## 游戏规则

### 游戏概述

4x4暗棋是一种在4×4棋盘上进行的中国象棋变体游戏。游戏开始时，所有棋子背面朝上随机分布在棋盘上，双方轮流进行翻棋和移动棋子。

### 棋子类型与价值

游戏包含7种不同的棋子，每种棋子都有特定的价值和数量：

| 棋子类型 | 价值 | 数量(每方) | 英文名 |
|---------|------|-----------|--------|
| 兵      | 4分  | 2个       | SOLDIER |
| 炮      | 10分 | 1个       | CANNON |
| 马      | 10分 | 1个       | HORSE |
| 车      | 10分 | 1个       | CHARIOT |
| 象      | 10分 | 1个       | ELEPHANT |
| 士      | 20分 | 1个       | ADVISOR |
| 将      | 30分 | 1个       | GENERAL |

#### 该分支为进一步简化版本

游戏包含5种不同的棋子，每种棋子都有特定的价值和数量：

| 棋子类型 | 价值 | 数量(每方) | 英文名 |
|---------|------|-----------|--------|


**胜利条件**：率先获得60分的玩家获胜。

### 基本操作

#### 1. 翻棋
- 玩家可以翻开任意一个未翻开的棋子
- 翻棋后该棋子变为明棋，归属确定
- 翻棋消耗回合

#### 2. 移动
- 只有已翻开的己方棋子可以移动
- 普通棋子只能向上下左右四个方向移动一格
- 未翻开的棋子无法移动

### 吃子规则

#### 等级制度
棋子遵循严格的等级制度，高等级棋子可以吃掉低等级和同等级的棋子：

**等级顺序（从低到高）**：
```
兵 < 炮 < 马 < 车 < 象 < 士 < 将
```

**基本吃子规则**：
- 高等级棋子可以吃掉所有低等级和同等级的敌方棋子
- 低等级棋子无法吃掉高等级棋子
- 例如：车可以吃兵、炮、马、车，但不能吃象、士、将

#### 特殊规则
1. **兵克将**：兵可以吃掉敌方的将（唯一例外）
2. **将怕兵**：将不能吃掉敌方的兵
3. **暗棋不可吃**：除炮以外，所有棋子都不能吃掉未翻开的棋子

### 炮的特殊机制

炮是游戏中最特殊的棋子，具有独特的攻击方式：

#### 炮的攻击规则
- **不能普通移动**：炮不能移动到相邻的空格
- **隔子攻击**：炮只能通过"隔一个棋子攻击"的方式改变位置
- **攻击条件**：炮与目标之间必须恰好有一个棋子作为"炮架"
- **攻击方向**：只能在水平或垂直方向进行隔子攻击

#### 炮的攻击目标
炮可以攻击：
- 所有敌方棋子（包括已翻开和未翻开的）
- 未翻开的己方棋子
- **不能攻击**：已翻开的己方棋子

#### 炮架规则
- 炮架可以是任意棋子（己方、敌方、明棋、暗棋均可）
- 炮架不会被消耗或影响
- 攻击路径上只能有一个炮架

### 游戏结束条件

#### 胜利条件
1. **积分胜利**：率先获得60分的玩家获胜
2. **无棋可走**：对手无任何合法动作时，当前玩家获胜

#### 平局条件
1. **回合限制**：连续24个回合没有吃子发生
2. **步数限制**：游戏总步数达到100步